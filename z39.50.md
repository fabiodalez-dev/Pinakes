# Documentazione Plugin Z39.50/SRU Integration

## Panoramica
Il plugin **Z39.50/SRU Integration** trasforma la tua biblioteca in un nodo interconnesso del sistema bibliotecario globale. Offre due funzionalità principali:
1.  **Client SRU (Copy Cataloging)**: Permette di importare automaticamente i metadati dei libri (titolo, autore, editore, ecc.) cercando per ISBN su cataloghi nazionali e internazionali (es. SBN, Library of Congress, WorldCat).
2.  **Server SRU**: Espone il catalogo della tua biblioteca via protocollo SRU standard, permettendo ad altre biblioteche di cercare e visualizzare i tuoi libri.

## Configurazione

### Accesso alle Impostazioni
1.  Vai nel pannello di amministrazione: **Admin > Plugin**.
2.  Individua il plugin **Z39.50/SRU Integration**.
3.  Clicca sul pulsante **Configura Z39.50**.

### Configurazione Client (Importazione Libri)
Per abilitare l'importazione da ISBN:
1.  Spunta la casella **Abilita Client SRU**.
2.  Nella sezione "Server Esterni", aggiungi i server che desideri interrogare.

#### Parametri Server
Per ogni server puoi configurare:
*   **Nome Server**: Un nome descrittivo (es. "SBN Nazionale", "Library of Congress").
*   **URL Endpoint SRU**: L'indirizzo web del servizio SRU.
    *   *Esempio SBN*: `https://opac.sbn.it/sru` (Nota: verificare l'URL specifico per il servizio SRU di SBN se disponibile pubblicamente, o usare endpoint di poli specifici).
    *   *Esempio LOC*: `http://lx2.loc.gov:210/LCDB`
*   **Database**: Il nome del database target (spesso richiesto da SBN, es. `nopac` o `sbn`). Lasciare vuoto se non richiesto.
*   **Indice ISBN**: L'indice CQL da usare per la ricerca ISBN.
    *   Default: `isbn`
    *   Library of Congress: `bath.isbn`
    *   Altri server potrebbero usare `bib.isbn` o `dc.identifier`.
*   **Sintassi**: Il formato dei dati atteso.
    *   `MARCXML` (Consigliato, supportato nativamente).
    *   `Dublin Core` (Supporto parziale).

### Configurazione Server (Esposizione Catalogo)
Per rendere il tuo catalogo ricercabile da altri:
1.  Spunta la casella **Abilita Server SRU**.
2.  Il tuo endpoint sarà disponibile all'indirizzo mostrato nel box informativo (es. `http://tuosito.com/api/sru`).
3.  Puoi testare il funzionamento cliccando sull'icona di link esterno (operazione `explain`).

## Utilizzo

### Importazione Libri (Copy Cataloging)
1.  Vai su **Libri > Nuovo Libro**.
2.  Nel campo "ISBN", inserisci il codice ISBN del libro (10 o 13 cifre).
3.  Clicca sul pulsante **Importa da ISBN**.
4.  Il sistema interrogherà sequenzialmente i server configurati.
5.  Se il libro viene trovato, i campi del form (Titolo, Autori, Editore, Anno, ecc.) verranno compilati automaticamente.

### Ricerca Federata (Prossimamente)
In futuro sarà disponibile una pagina dedicata per cercare simultaneamente su tutti i cataloghi configurati senza dover creare un nuovo libro.

## Risoluzione Problemi

### Il libro non viene trovato
*   Verifica che l'ISBN sia corretto.
*   Assicurati che i server configurati siano attivi e raggiungibili.
*   Controlla l'**Indice ISBN** nelle impostazioni del server. Alcuni server (come Library of Congress) richiedono `bath.isbn` invece di `isbn`.

### Errore di connessione
*   Verifica la connessione internet del server ospitante la biblioteca.
*   Controlla i log di sistema (`storage/logs`) per dettagli sull'errore HTTP.

### Dati incompleti
*   Il mapping dei campi dipende dalla qualità dei dati MARCXML restituiti dal server esterno. Alcuni campi potrebbero non essere presenti nel record originale.

## Dettagli Tecnici per Sviluppatori

### Struttura Plugin
*   **Path**: `storage/plugins/z39-server/`
*   **Classe Client**: `classes/SruClient.php` - Gestisce le chiamate HTTP e il parsing XML.
*   **Classe Server**: `classes/SRUServer.php` - Gestisce le richieste in ingresso.
*   **Endpoint**: `endpoint.php` - Entry point per le richieste API SRU.

### Estensione Mappatura
Per modificare la mappatura dei campi MARCXML, modificare il metodo `parseMarcXml` in `classes/SruClient.php`.

### Hook
Il client si aggancia all'hook `scrape.fetch.custom` definito in `app/Controllers/ScrapeController.php`.
```php
$hookManager->addHook('scrape.fetch.custom', [$this, 'fetchBookMetadata'], 10);
```
