name: Create Release Package

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-release:
    name: Build and Package Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup PHP 8.1
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, pdo, mbstring, json, openssl, curl
          tools: composer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync zip

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Install NPM dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend assets
        working-directory: frontend
        run: npm run build

      - name: Verify version.json matches tag
        run: |
          VERSION_JSON=$(jq -r '.version' version.json)
          if [ "$VERSION_JSON" != "${{ steps.version.outputs.VERSION }}" ]; then
            echo "‚ùå Version mismatch: version.json ($VERSION_JSON) != tag (${{ steps.version.outputs.VERSION }})"
            exit 1
          fi
          echo "‚úÖ Version verified: $VERSION_JSON"

      - name: Make build script executable
        run: chmod +x bin/build-release.sh

      - name: Create release package
        run: ./bin/build-release.sh

      - name: Verify package files exist
        run: |
          if [ ! -f "releases/pinakes-v${{ steps.version.outputs.VERSION }}.zip" ]; then
            echo "‚ùå Release ZIP not found"
            exit 1
          fi
          if [ ! -f "releases/pinakes-v${{ steps.version.outputs.VERSION }}.zip.sha256" ]; then
            echo "‚ùå Checksum file not found"
            exit 1
          fi
          if [ ! -f "releases/RELEASE_NOTES-v${{ steps.version.outputs.VERSION }}.md" ]; then
            echo "‚ùå Release notes not found"
            exit 1
          fi
          echo "‚úÖ All package files verified"

      - name: Extract changelog for this version
        id: changelog
        run: |
          if [ -f "CHANGELOG.md" ]; then
            # Extract changelog section for this version
            VERSION_SECTION=$(awk "/## \[${VERSION}\]/{flag=1;next}/## \[/{flag=0}flag" CHANGELOG.md || echo "See CHANGELOG.md for details")
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "$VERSION_SECTION" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG=See release notes for details" >> $GITHUB_OUTPUT
          fi
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Pinakes v${{ steps.version.outputs.VERSION }}
          body: |
            # Pinakes v${{ steps.version.outputs.VERSION }}

            > ‚ö†Ô∏è **UPGRADING FROM v0.4.1 - v0.4.3?**
            >
            > The built-in updater has a bug that prevents automatic updates on shared hosting.
            > **You must manually patch the updater first:**
            >
            > 1. Download `test-updater/` folder from this release
            > 2. Upload the `app/` folder via FTP, overwriting existing files
            > 3. Then retry the update from Admin ‚Üí Updates
            >
            > Or upload `test-updater/manual-update.php` to your site root and access it via browser.
            > See `test-updater/README.md` for detailed instructions.

            ---

            ${{ steps.changelog.outputs.CHANGELOG }}

            ---

            ## üì¶ Download

            Download `pinakes-v${{ steps.version.outputs.VERSION }}.zip` and verify checksum:

            ```bash
            shasum -a 256 -c pinakes-v${{ steps.version.outputs.VERSION }}.zip.sha256
            ```

            ## üìã Installation (New Installations)

            1. Extract archive:
               ```bash
               unzip pinakes-v${{ steps.version.outputs.VERSION }}.zip
               cd pinakes-v${{ steps.version.outputs.VERSION }}
               ```

            2. Configure environment:
               ```bash
               cp .env.example .env
               # Edit .env with your settings
               ```

            3. Run web installer at: http://yourdomain.com

            See README.md in the package for complete documentation.
          files: |
            releases/pinakes-v${{ steps.version.outputs.VERSION }}.zip
            releases/pinakes-v${{ steps.version.outputs.VERSION }}.zip.sha256
            releases/RELEASE_NOTES-v${{ steps.version.outputs.VERSION }}.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-package-v${{ steps.version.outputs.VERSION }}
          path: |
            releases/pinakes-v${{ steps.version.outputs.VERSION }}.zip
            releases/pinakes-v${{ steps.version.outputs.VERSION }}.zip.sha256
            releases/RELEASE_NOTES-v${{ steps.version.outputs.VERSION }}.md
          retention-days: 90
